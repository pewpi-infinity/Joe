<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>‚àû Infinity Login</title>
  <meta name="color-scheme" content="light dark"/>
  <link rel="stylesheet" href="assets/css/infinity-design.css" />
  <style>
    html, body { 
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-container {
      width: 100%;
      max-width: 420px;
      padding: 20px;
    }
    
    .logo-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo-text {
      font-weight: 800;
      color: var(--blue-1);
      font-size: 48px;
      letter-spacing: 3px;
      margin: 0;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .logo-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 8px;
      letter-spacing: 0.5px;
    }
    
    .login-card h2 {
      margin: 0 0 8px 0;
      color: var(--blue-1);
      font-size: 24px;
      font-weight: 700;
    }
    
    .login-card .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      color: var(--blue-1);
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .encryption-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      padding: 12px;
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 8px;
      font-size: 13px;
      color: #15803d;
    }
    
    .encryption-badge::before {
      content: "üîí";
      font-size: 16px;
    }
    
    .mongoose-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
      padding: 10px;
      background: rgba(11, 95, 215, 0.08);
      border: 1px solid rgba(11, 95, 215, 0.2);
      border-radius: 8px;
      font-size: 12px;
      color: var(--blue-2);
    }
    
    .mongoose-badge::before {
      content: "üêç";
      font-size: 16px;
    }
    
    .divider {
      margin: 24px 0;
      text-align: center;
      position: relative;
    }
    
    .divider::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: #e6e9ef;
    }
    
    .divider span {
      position: relative;
      background: var(--panel);
      padding: 0 12px;
      color: var(--muted);
      font-size: 13px;
    }
    
    .toggle-mode {
      text-align: center;
      margin-top: 20px;
    }
    
    .toggle-mode button {
      background: none;
      border: none;
      color: var(--blue-2);
      font-weight: 600;
      cursor: pointer;
      text-decoration: underline;
      font-size: 14px;
    }
    
    .info-box {
      margin-top: 24px;
      padding: 16px;
      background: rgba(11, 95, 215, 0.05);
      border: 1px solid rgba(11, 95, 215, 0.1);
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
    }
    
    .info-box strong {
      color: var(--blue-1);
    }
    
    @media (max-width: 600px) {
      .logo-text {
        font-size: 36px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="logo-header">
      <h1 class="logo-text">‚àû</h1>
      <p class="logo-subtitle">Infinity AI Platform</p>
    </div>
    
    <div class="card login-card">
      <h2 id="cardTitle">Welcome</h2>
      <p class="subtitle">Secure login with end-to-end encryption</p>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" name="email" required autocomplete="email" placeholder="your@email.com" class="input">
        </div>
        
        <div class="form-group">
          <label for="username">Display Name</label>
          <input type="text" id="username" name="username" required autocomplete="name" placeholder="Your Name" class="input">
        </div>
        
        <div class="form-group">
          <label for="passphrase">Secure Passphrase</label>
          <input type="password" id="passphrase" name="passphrase" required autocomplete="current-password" placeholder="Enter your passphrase" class="input">
        </div>
        
        <button type="submit" class="btn-primary" id="submitBtn">
          <span id="btnText">Continue</span>
        </button>
        
        <div class="encryption-badge">
          End-to-end encrypted with Web Crypto API (AES-GCM)
        </div>
        
        <div class="mongoose-badge" id="mongooseBadge">
          <span id="mongooseStatus">Mongoose OS: Checking...</span>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
      </form>
      
      <div class="toggle-mode">
        <button type="button" id="toggleMode">New user? Create account</button>
      </div>
      
      <div class="info-box">
        <strong>Infinity AI-to-AI Security:</strong> Your credentials are encrypted locally using military-grade AES-256-GCM encryption. Mongoose OS AI firmware provides additional authentication layer. All data is secured within your browser.
      </div>
    </div>
  </div>

  <script src="assets/js/infinity-auth.js"></script>
  <script src="mongoose/lib/mongoose-client.js"></script>
  <script>
    let isSignupMode = false;
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', async () => {
      checkExistingSession();
      setupEventListeners();
      await checkMongooseStatus();
    });
    
    async function checkMongooseStatus() {
      const health = await window.MongooseClient.healthCheck();
      const badge = document.getElementById('mongooseStatus');
      
      if (health.healthy) {
        badge.textContent = `Mongoose OS: ${health.mode} mode ‚úì`;
        badge.style.color = '#22c55e';
      } else {
        badge.textContent = 'Mongoose OS: Offline (using fallback)';
        badge.style.color = '#f59e0b';
      }
    }
    
    function setupEventListeners() {
      document.getElementById('loginForm').addEventListener('submit', handleFormSubmit);
      document.getElementById('toggleMode').addEventListener('click', toggleAuthMode);
    }
    
    function toggleAuthMode() {
      isSignupMode = !isSignupMode;
      const cardTitle = document.getElementById('cardTitle');
      const toggleBtn = document.getElementById('toggleMode');
      const btnText = document.getElementById('btnText');
      
      if (isSignupMode) {
        cardTitle.textContent = 'Create Account';
        toggleBtn.textContent = 'Already have an account? Login';
        btnText.textContent = 'Create Account';
      } else {
        cardTitle.textContent = 'Welcome Back';
        toggleBtn.textContent = 'New user? Create account';
        btnText.textContent = 'Login';
      }
    }
    
    async function handleFormSubmit(event) {
      event.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const username = document.getElementById('username').value.trim();
      const passphrase = document.getElementById('passphrase').value;
      
      if (!email || !username || !passphrase) {
        showStatus('Please fill in all fields', 'error');
        return;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      document.getElementById('btnText').textContent = 'Processing...';
      
      try {
        let result;
        
        if (isSignupMode) {
          result = await InfinityAuth.signup(email, username, passphrase);
        } else {
          result = await InfinityAuth.login(email, username, passphrase);
        }
        
        if (result.success) {
          // Authenticate with Mongoose OS
          const mongooseAuth = await window.MongooseClient.authenticate({
            email: email,
            username: username,
            userId: result.user.userId
          });
          
          if (mongooseAuth.success) {
            console.log('Mongoose OS authentication successful');
          }
          
          showStatus(isSignupMode ? 'Account created successfully! Redirecting...' : 'Login successful! Redirecting...', 'success');
          setTimeout(() => redirectToApp(), 1500);
        } else {
          showStatus(result.error || 'Authentication failed', 'error');
          submitBtn.disabled = false;
          document.getElementById('btnText').textContent = isSignupMode ? 'Create Account' : 'Login';
          
          if (result.error === 'No account found' && !isSignupMode) {
            setTimeout(() => {
              isSignupMode = true;
              toggleAuthMode();
            }, 1500);
          }
        }
      } catch (error) {
        console.error('Authentication error:', error);
        showStatus('Authentication failed. Please try again.', 'error');
        submitBtn.disabled = false;
        document.getElementById('btnText').textContent = isSignupMode ? 'Create Account' : 'Login';
      }
    }
    
    function checkExistingSession() {
      if (InfinityAuth.isAuthenticated()) {
        redirectToApp();
      }
    }
    
    function showStatus(message, type) {
      const statusElement = document.getElementById('statusMessage');
      statusElement.textContent = message;
      statusElement.className = 'status-message ' + type;
      statusElement.style.display = 'block';
      
      if (type === 'error') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }
    
    function redirectToApp() {
      const urlParams = new URLSearchParams(window.location.search);
      const redirectUrl = urlParams.get('redirect');
      
      if (redirectUrl) {
        window.location.href = decodeURIComponent(redirectUrl);
      } else {
        window.location.href = 'dashboard.html';
      }
    }
  </script>
</body>
</html>
