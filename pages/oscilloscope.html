<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Oscilloscope - Infinity Portal</title>
  <link rel="stylesheet" href="../assets/css/infinity-design.css" />
  <style>
    :root{
      --bg:#0c1420; --bg2:#0f1a2a; --card:#101e30; --edge:#14243a;
      --text:#eaf1ff; --muted:#a7b6d9; --brand:#1f6fff; --chip:#2563eb;
    }
    body{background:linear-gradient(120deg,#06101f,#0e1b30 70%); color:var(--text);}
    .chip{display:inline-block;background:linear-gradient(180deg,#2a54a3,#184285);padding:.35rem .6rem;border-radius:999px;font-size:.8rem}
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    canvas{width:100%;height:240px;background:#061326;border:1px solid #1a2c4d;border-radius:12px;margin-top:1rem}
    .footer{opacity:.8;font-size:.85rem;margin-top:.6rem;text-align:center;}
    input[type="range"]{width:120px}
    label{margin-right:0.3rem}
  </style>
</head>
<body>
  <div class="header" style="background:linear-gradient(180deg,#091425,transparent);backdrop-filter:blur(8px);">
    <div class="header-content">
      <a href="../dashboard.html" class="logo">‚àû INFINITY</a>
      <div class="nav">
        <a href="../pages/chat.html">Chat</a>
        <a href="../pages/pi-singer.html">Pi Singer</a>
        <a href="../pages/oscilloscope.html" class="active">Oscilloscope</a>
        <a href="../pages/3d-viewer.html">3D Viewer</a>
        <a href="../dashboard.html">Dashboard</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="chip">Signal Generator + Oscilloscope</div>
      <div class="row" style="margin-top:1rem;flex-wrap:wrap">
        <label>Mode:</label>
        <select id="modeSel" class="input" style="width:150px">
          <option value="single">Single frequency</option>
          <option value="two">Two tones</option>
          <option value="chord">Chord (3)</option>
        </select>
        <label>Freq (Hz):</label>
        <input id="f1" type="range" min="50" max="2000" value="440"/>
        <span id="f1v">440</span>
        <label id="f2lbl" style="display:none">F2:</label>
        <input id="f2" type="range" min="50" max="2000" value="660" style="display:none"/>
        <span id="f2v" style="display:none">660</span>
        <label id="f3lbl" style="display:none">F3:</label>
        <input id="f3" type="range" min="50" max="2000" value="880" style="display:none"/>
        <span id="f3v" style="display:none">880</span>
      </div>
      <div class="row" style="margin-top:0.5rem">
        <label>Amplitude:</label>
        <input id="amp" type="range" min="0" max="1" step="0.01" value="0.3"/>
        <span id="ampv">0.30</span>
        <label>Beat (Hz):</label>
        <input id="beat" type="range" min="0" max="20" step="0.1" value="2"/>
        <span id="beatv">2.0</span>
        <button class="btn-primary" onclick="startGen()">Start</button>
        <button class="btn-secondary" onclick="stopAll()">Stop</button>
      </div>
      <canvas id="scopeCanvas"></canvas>
      <div class="footer">Real-time signal generation with frequency, amplitude, and beat control.</div>
    </div>
  </div>

  <script src="../assets/js/infinity-auth.js"></script>
  <script>
    // Check authentication
    if (!InfinityAuth.requireAuth()) {
      // Will redirect to login
    }

    let ac, master, analyser, scopeTimer, nodes=[];
    
    function ensureAudio(){
      if(!ac){ 
        ac = new (window.AudioContext || window.webkitAudioContext)(); 
        master = ac.createGain(); 
        master.gain.value = 0.2; 
        analyser = ac.createAnalyser(); 
        analyser.fftSize = 2048; 
        master.connect(analyser); 
        analyser.connect(ac.destination); 
      }
    }

    function startGen(){
      ensureAudio(); 
      stopAll();
      
      const mode = document.getElementById('modeSel').value;
      const amp = parseFloat(document.getElementById('amp').value); 
      document.getElementById('ampv').textContent=amp.toFixed(2);
      const beat = parseFloat(document.getElementById('beat').value); 
      document.getElementById('beatv').textContent=beat.toFixed(1);
      
      function addOsc(freq){
        const o = ac.createOscillator(); 
        const g = ac.createGain();
        o.type='sine'; 
        o.frequency.value = freq;
        
        // Beat = slow amplitude modulation
        const lfo = ac.createOscillator(); 
        const lfoGain = ac.createGain(); 
        lfo.frequency.value = beat; 
        lfoGain.gain.value = amp/2;
        lfo.connect(lfoGain).connect(g.gain);
        
        g.gain.value = amp/2; 
        o.connect(g); 
        g.connect(master);
        o.start(); 
        lfo.start(); 
        nodes.push(o,g,lfo,lfoGain);
      }
      
      const f1 = parseInt(document.getElementById('f1').value); 
      document.getElementById('f1v').textContent=f1;
      addOsc(f1);
      
      if(mode!=='single'){
        const f2 = parseInt(document.getElementById('f2').value); 
        document.getElementById('f2v').textContent=f2;
        addOsc(f2);
      }
      
      if(mode==='chord'){
        const f3 = parseInt(document.getElementById('f3').value); 
        document.getElementById('f3v').textContent=f3;
        addOsc(f3);
      }
      
      drawScope(document.getElementById('scopeCanvas'));
    }

    function drawScope(canvas){
      if(!analyser) return;
      const ctx = canvas.getContext('2d'); 
      const buf = new Uint8Array(analyser.fftSize);
      if(scopeTimer) cancelAnimationFrame(scopeTimer);
      
      function frame(){
        analyser.getByteTimeDomainData(buf);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.beginPath(); 
        const h=canvas.height, w=canvas.width;
        for(let i=0;i<w;i++){ 
          const v = buf[Math.floor(i/w*buf.length)]/128.0 - 1.0; 
          const y = h/2 + v*h*0.4; 
          i?ctx.lineTo(i,y):ctx.moveTo(i,y); 
        }
        ctx.strokeStyle="#6aa7ff"; 
        ctx.lineWidth=2; 
        ctx.stroke();
        scopeTimer = requestAnimationFrame(frame);
      }
      frame();
    }

    function stopAll(){
      nodes.forEach(n=>{ 
        try{ 
          if(n.stop) n.stop(); 
          if(n.disconnect) n.disconnect(); 
        }catch(e){} 
      }); 
      nodes=[];
      if(scopeTimer) cancelAnimationFrame(scopeTimer);
    }

    // Mode UI dynamics
    const modeSel=document.getElementById('modeSel'); 
    const f2=document.getElementById('f2'), f2v=document.getElementById('f2v'), f2lbl=document.getElementById('f2lbl');
    const f3=document.getElementById('f3'), f3v=document.getElementById('f3v'), f3lbl=document.getElementById('f3lbl');
    
    function refreshMode(){
      const m = modeSel.value;
      [f2,f2v,f2lbl].forEach(el=>el.style.display = (m==='single')?'none':'inline');
      [f3,f3v,f3lbl].forEach(el=>el.style.display = (m==='chord')?'inline':'none');
    }
    
    modeSel.addEventListener('change', refreshMode); 
    refreshMode();
    
    ['f1','f2','f3','amp','beat'].forEach(id=>{ 
      const el=document.getElementById(id); 
      if(el) el.addEventListener('input', e=>document.getElementById(id+'v').textContent=e.target.value); 
    });
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>‚àû Oscilloscope - Infinity Portal</title>
  <style>
    :root {
      --bg: #0c1420;
      --bg2: #0f1a2a;
      --card: #101e30;
      --edge: #14243a;
      --text: #eaf1ff;
      --muted: #a7b6d9;
      --brand: #1f6fff;
      --chip: #2563eb;
    }
    
    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      background: linear-gradient(120deg, #06101f, #0e1b30 70%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      min-height: 100vh;
    }
    
    .wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    .card {
      background: radial-gradient(1200px 400px at 50% -100%, rgba(37, 99, 235, 0.4), transparent 60%), var(--card);
      border: 1px solid var(--edge);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
      margin-bottom: 1rem;
    }
    
    .chip {
      display: inline-block;
      background: linear-gradient(180deg, #2a54a3, #184285);
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      margin-bottom: 1rem;
    }
    
    .token-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 1rem;
    }
    
    .token-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffd700;
    }
    
    .page-info {
      background: rgba(31, 111, 255, 0.1);
      border: 1px solid rgba(31, 111, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .page-info h3 {
      margin: 0 0 0.5rem 0;
      color: var(--brand);
    }
    
    .page-info p {
      margin: 0.25rem 0;
      color: var(--muted);
      font-size: 0.9rem;
    }
    
    .row {
      display: flex;
      gap: 0.6rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn {
      background: linear-gradient(180deg, #2a59b4, #1f49a0);
      border: 1px solid #3764bf;
      color: white;
      border-radius: 14px;
      padding: 0.6rem 0.9rem;
      cursor: pointer;
    }
    
    canvas {
      width: 100%;
      height: 300px;
      background: #061326;
      border: 1px solid #1a2c4d;
      border-radius: 12px;
      margin-top: 1rem;
    }
    
    .footer {
      opacity: 0.8;
      font-size: 0.85rem;
      margin-top: 0.6rem;
    }
    
    input[type="number"], input[type="range"], select {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--edge);
      background: var(--bg2);
      color: var(--text);
    }
    
    label {
      font-weight: 600;
    }
  </style>
</head>
<body>

<div id="infinity-header-mount"></div>

<main class="wrap">
  <!-- Token Display -->
  <div class="token-display">
    <span>üß±üçÑ‚≠ê</span>
    <span class="token-value">Token Value: 38</span>
    <span style="margin-left: auto; font-size: 0.8rem; color: var(--muted);">Signal generation free</span>
  </div>
  
  <!-- Page Info -->
  <div class="page-info">
    <h3>üìà Oscilloscope - Signal Generator & Visualizer</h3>
    <p><strong>Purpose:</strong> Generate and visualize audio waveforms in real-time</p>
    <p><strong>Research Area:</strong> Signal processing, frequency analysis, waveform synthesis</p>
    <p><strong>Building Status:</strong> Complete - Multi-mode signal generator with live visualization</p>
  </div>
  
  <!-- Oscilloscope Interface -->
  <div class="card">
    <div class="chip">Oscilloscope ¬∑ Signal Generator</div>
    <div class="row">
      <label>Mode:</label>
      <select id="modeSel">
        <option value="single">Single Tone</option>
        <option value="dual">Dual Tone</option>
        <option value="chord">Chord (3 tones)</option>
      </select>
      <label>F1:</label>
      <input id="f1" type="range" min="100" max="2000" value="440"/>
      <span id="f1v">440</span>Hz
      <label id="f2lbl">F2:</label>
      <input id="f2" type="range" min="100" max="2000" value="554"/>
      <span id="f2v">554</span>Hz
      <label id="f3lbl" style="display:none">F3:</label>
      <input id="f3" type="range" min="100" max="2000" value="659" style="display:none"/>
      <span id="f3v" style="display:none">659</span>Hz
      <button class="btn" onclick="playSig()">Play</button>
      <button class="btn" onclick="stopSig()">Stop</button>
    </div>
    <canvas id="scopeCanvas"></canvas>
    <div class="footer">Real-time frequency visualization with multi-tone support.</div>
  </div>
</main>

<script src="../pages/shared-header.js"></script>
<script src="../chat/widget.js"></script>

<script>
// Oscilloscope Implementation
let sigCtx, sigOscs = [], sigGain, sigAnalyser, sigAnim;

function playSig() {
  stopSig();
  const mode = document.getElementById('modeSel').value;
  const f1 = parseFloat(document.getElementById('f1').value);
  const f2 = parseFloat(document.getElementById('f2').value);
  const f3 = parseFloat(document.getElementById('f3').value);

  sigCtx = new (window.AudioContext || window.webkitAudioContext)();
  sigAnalyser = sigCtx.createAnalyser();
  sigAnalyser.fftSize = 2048;
  sigGain = sigCtx.createGain();
  sigGain.gain.value = 0.2;

  const freqs = mode === 'single' ? [f1] : mode === 'dual' ? [f1, f2] : [f1, f2, f3];
  
  freqs.forEach(freq => {
    const osc = sigCtx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = freq;
    osc.connect(sigGain);
    osc.start();
    sigOscs.push(osc);
  });

  sigGain.connect(sigAnalyser);
  sigAnalyser.connect(sigCtx.destination);

  const canvas = document.getElementById('scopeCanvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;

  function drawScope() {
    sigAnim = requestAnimationFrame(drawScope);
    const bufferLength = sigAnalyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    sigAnalyser.getByteTimeDomainData(dataArray);

    ctx.fillStyle = '#061326';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 3;
    ctx.strokeStyle = '#1f6fff';
    ctx.beginPath();

    const sliceWidth = canvas.width / bufferLength;
    let x = 0;

    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 128.0;
      const y = v * canvas.height / 2;

      if (i === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }

      x += sliceWidth;
    }

    ctx.lineTo(canvas.width, canvas.height / 2);
    ctx.stroke();
  }

  drawScope();
}

function stopSig() {
  sigOscs.forEach(osc => {
    try { osc.stop(); } catch(e) {}
  });
  sigOscs = [];
  if (sigAnim) {
    cancelAnimationFrame(sigAnim);
    sigAnim = null;
  }
  if (sigCtx) {
    sigCtx.close();
    sigCtx = null;
  }
}

// Mode UI dynamics
const modeSel = document.getElementById('modeSel');
const f2 = document.getElementById('f2');
const f2v = document.getElementById('f2v');
const f2lbl = document.getElementById('f2lbl');
const f3 = document.getElementById('f3');
const f3v = document.getElementById('f3v');
const f3lbl = document.getElementById('f3lbl');

function refreshMode() {
  const m = modeSel.value;
  [f2, f2v, f2lbl].forEach(el => el.style.display = (m === 'single') ? 'none' : 'inline');
  [f3, f3v, f3lbl].forEach(el => el.style.display = (m === 'chord') ? 'inline' : 'none');
}

modeSel.addEventListener('change', refreshMode);
refreshMode();

['f1', 'f2', 'f3'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('input', e => {
      document.getElementById(id + 'v').textContent = e.target.value;
    });
  }
});
</script>

</body>
</html>
