<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Oscilloscope - Infinity Portal</title>
  <link rel="stylesheet" href="../assets/css/infinity-design.css" />
  <style>
    :root{
      --bg:#0c1420; --bg2:#0f1a2a; --card:#101e30; --edge:#14243a;
      --text:#eaf1ff; --muted:#a7b6d9; --brand:#1f6fff; --chip:#2563eb;
    }
    body{background:linear-gradient(120deg,#06101f,#0e1b30 70%); color:var(--text);}
    .chip{display:inline-block;background:linear-gradient(180deg,#2a54a3,#184285);padding:.35rem .6rem;border-radius:999px;font-size:.8rem}
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    canvas{width:100%;height:240px;background:#061326;border:1px solid #1a2c4d;border-radius:12px;margin-top:1rem}
    .footer{opacity:.8;font-size:.85rem;margin-top:.6rem;text-align:center;}
    input[type="range"]{width:120px}
    label{margin-right:0.3rem}
  </style>
</head>
<body>
  <div class="header" style="background:linear-gradient(180deg,#091425,transparent);backdrop-filter:blur(8px);">
    <div class="header-content">
      <a href="../dashboard.html" class="logo">âˆž INFINITY</a>
      <div class="nav">
        <a href="../pages/chat.html">Chat</a>
        <a href="../pages/pi-singer.html">Pi Singer</a>
        <a href="../pages/oscilloscope.html" class="active">Oscilloscope</a>
        <a href="../pages/3d-viewer.html">3D Viewer</a>
        <a href="../dashboard.html">Dashboard</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="chip">Signal Generator + Oscilloscope</div>
      <div class="row" style="margin-top:1rem;flex-wrap:wrap">
        <label>Mode:</label>
        <select id="modeSel" class="input" style="width:150px">
          <option value="single">Single frequency</option>
          <option value="two">Two tones</option>
          <option value="chord">Chord (3)</option>
        </select>
        <label>Freq (Hz):</label>
        <input id="f1" type="range" min="50" max="2000" value="440"/>
        <span id="f1v">440</span>
        <label id="f2lbl" style="display:none">F2:</label>
        <input id="f2" type="range" min="50" max="2000" value="660" style="display:none"/>
        <span id="f2v" style="display:none">660</span>
        <label id="f3lbl" style="display:none">F3:</label>
        <input id="f3" type="range" min="50" max="2000" value="880" style="display:none"/>
        <span id="f3v" style="display:none">880</span>
      </div>
      <div class="row" style="margin-top:0.5rem">
        <label>Amplitude:</label>
        <input id="amp" type="range" min="0" max="1" step="0.01" value="0.3"/>
        <span id="ampv">0.30</span>
        <label>Beat (Hz):</label>
        <input id="beat" type="range" min="0" max="20" step="0.1" value="2"/>
        <span id="beatv">2.0</span>
        <button class="btn-primary" onclick="startGen()">Start</button>
        <button class="btn-secondary" onclick="stopAll()">Stop</button>
      </div>
      <canvas id="scopeCanvas"></canvas>
      <div class="footer">Real-time signal generation with frequency, amplitude, and beat control.</div>
    </div>
  </div>

  <script src="../assets/js/infinity-auth.js"></script>
  <script>
    // Check authentication
    if (!InfinityAuth.requireAuth()) {
      // Will redirect to login
    }

    let ac, master, analyser, scopeTimer, nodes=[];
    
    function ensureAudio(){
      if(!ac){ 
        ac = new (window.AudioContext || window.webkitAudioContext)(); 
        master = ac.createGain(); 
        master.gain.value = 0.2; 
        analyser = ac.createAnalyser(); 
        analyser.fftSize = 2048; 
        master.connect(analyser); 
        analyser.connect(ac.destination); 
      }
    }

    function startGen(){
      ensureAudio(); 
      stopAll();
      
      const mode = document.getElementById('modeSel').value;
      const amp = parseFloat(document.getElementById('amp').value); 
      document.getElementById('ampv').textContent=amp.toFixed(2);
      const beat = parseFloat(document.getElementById('beat').value); 
      document.getElementById('beatv').textContent=beat.toFixed(1);
      
      function addOsc(freq){
        const o = ac.createOscillator(); 
        const g = ac.createGain();
        o.type='sine'; 
        o.frequency.value = freq;
        
        // Beat = slow amplitude modulation
        const lfo = ac.createOscillator(); 
        const lfoGain = ac.createGain(); 
        lfo.frequency.value = beat; 
        lfoGain.gain.value = amp/2;
        lfo.connect(lfoGain).connect(g.gain);
        
        g.gain.value = amp/2; 
        o.connect(g); 
        g.connect(master);
        o.start(); 
        lfo.start(); 
        nodes.push(o,g,lfo,lfoGain);
      }
      
      const f1 = parseInt(document.getElementById('f1').value); 
      document.getElementById('f1v').textContent=f1;
      addOsc(f1);
      
      if(mode!=='single'){
        const f2 = parseInt(document.getElementById('f2').value); 
        document.getElementById('f2v').textContent=f2;
        addOsc(f2);
      }
      
      if(mode==='chord'){
        const f3 = parseInt(document.getElementById('f3').value); 
        document.getElementById('f3v').textContent=f3;
        addOsc(f3);
      }
      
      drawScope(document.getElementById('scopeCanvas'));
    }

    function drawScope(canvas){
      if(!analyser) return;
      const ctx = canvas.getContext('2d'); 
      const buf = new Uint8Array(analyser.fftSize);
      if(scopeTimer) cancelAnimationFrame(scopeTimer);
      
      function frame(){
        analyser.getByteTimeDomainData(buf);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.beginPath(); 
        const h=canvas.height, w=canvas.width;
        for(let i=0;i<w;i++){ 
          const v = buf[Math.floor(i/w*buf.length)]/128.0 - 1.0; 
          const y = h/2 + v*h*0.4; 
          i?ctx.lineTo(i,y):ctx.moveTo(i,y); 
        }
        ctx.strokeStyle="#6aa7ff"; 
        ctx.lineWidth=2; 
        ctx.stroke();
        scopeTimer = requestAnimationFrame(frame);
      }
      frame();
    }

    function stopAll(){
      nodes.forEach(n=>{ 
        try{ 
          if(n.stop) n.stop(); 
          if(n.disconnect) n.disconnect(); 
        }catch(e){} 
      }); 
      nodes=[];
      if(scopeTimer) cancelAnimationFrame(scopeTimer);
    }

    // Mode UI dynamics
    const modeSel=document.getElementById('modeSel'); 
    const f2=document.getElementById('f2'), f2v=document.getElementById('f2v'), f2lbl=document.getElementById('f2lbl');
    const f3=document.getElementById('f3'), f3v=document.getElementById('f3v'), f3lbl=document.getElementById('f3lbl');
    
    function refreshMode(){
      const m = modeSel.value;
      [f2,f2v,f2lbl].forEach(el=>el.style.display = (m==='single')?'none':'inline');
      [f3,f3v,f3lbl].forEach(el=>el.style.display = (m==='chord')?'inline':'none');
    }
    
    modeSel.addEventListener('change', refreshMode); 
    refreshMode();
    
    ['f1','f2','f3','amp','beat'].forEach(id=>{ 
      const el=document.getElementById(id); 
      if(el) el.addEventListener('input', e=>document.getElementById(id+'v').textContent=e.target.value); 
    });
  </script>
</body>
</html>
