<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Infinity Dashboard</title>
  <meta name="color-scheme" content="light dark"/>
  <link rel="stylesheet" href="assets/css/infinity-design.css" />
  <style>
    .app { 
      max-width: 480px; 
      margin: 0 auto; 
      padding: 0 0 80px 0; 
    }
    
    .welcome-banner { 
      background: var(--gradient); 
      color: #fff; 
      padding: 20px; 
      border-radius: 12px; 
      margin-bottom: 20px; 
    }
    
    .welcome-banner h3 { 
      margin: 0 0 4px 0; 
      color: #fff;
    }
    
    .welcome-banner p { 
      margin: 0; 
      font-size: 14px; 
      opacity: 0.9; 
    }
    
    .apps { 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    
    .app-link { 
      background: var(--panel); 
      border-radius: 12px; 
      padding: 18px; 
      display: flex; 
      flex-direction: column; 
      align-items: flex-start;
      border: 1px solid rgba(0, 48, 135, 0.08);
      transition: all 0.2s;
    }
    
    .app-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 48, 135, 0.12);
    }
    
    .app-link a { 
      color: var(--blue-2); 
      font-weight: 700; 
      font-size: 18px; 
      text-decoration: none; 
    }
    
    .desc { 
      font-size: 14px; 
      color: var(--muted);
      margin-top: 6px;
    }
    
    .live { 
      color: #22c55e; 
      font-weight: 700; 
      font-size: 12px;
      margin-top: 8px;
    }

    /* Rogers Chat Widget */
    .rogersDock { 
      position: fixed; 
      right: 16px; 
      bottom: 16px; 
      z-index: 999; 
    }
    
    .rogBtn { 
      width: 56px; 
      height: 56px; 
      border-radius: 50%; 
      background: var(--gradient); 
      display: flex;
      align-items: center;
      justify-content: center; 
      color: #fff;
      font-weight: 900; 
      font-size: 24px; 
      box-shadow: 0 10px 30px rgba(11, 95, 215, 0.3); 
      cursor: pointer; 
      border: none;
    }
    
    .chatBox { 
      position: fixed; 
      right: 10px; 
      bottom: 80px; 
      width: 95vw; 
      max-width: 360px; 
      border-radius: 14px; 
      background: #fff; 
      box-shadow: 0 20px 50px rgba(3, 24, 62, 0.25); 
      display: none; 
      flex-direction: column; 
      z-index: 999; 
      overflow: hidden; 
      border: 1px solid #e6e9ef;
    }
    
    .chatBox.open { 
      display: flex; 
    }
    
    .chatHeader { 
      padding: 12px 16px; 
      background: var(--gradient); 
      color: #fff; 
      display: flex; 
      justify-content: space-between;
      align-items: center; 
      font-weight: bold;
    }
    
    .chatBody { 
      padding: 12px;
      height: 240px;
      overflow-y: auto;
      background: var(--panel);
      font-size: 15px;
    }
    
    .chatInput { 
      display: flex; 
      padding: 10px; 
      border-top: 1px solid #e6e9ef; 
      background: #f9fbfd;
    }
    
    .chatInput input { 
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e6e9ef;
      font-size: 16px;
    }
    
    .chatInput button { 
      background: var(--blue-1); 
      color: #fff; 
      border: none; 
      border-radius: 8px; 
      font-weight: 700; 
      padding: 10px 16px; 
      margin-left: 8px; 
      font-size: 16px;
      cursor: pointer;
    }
    
    .bubble { 
      margin: 8px 0; 
      max-width: 90%; 
      padding: 10px 14px; 
      border-radius: 14px; 
      word-break: break-word;
    }
    
    .me { 
      background: rgba(11, 95, 215, 0.1); 
      border: 1px solid rgba(11, 95, 215, 0.2);
      margin-left: auto;
    }
    
    .ai { 
      background: #fff; 
      border: 1px solid #e6e9ef;
    }

    .devBox { 
      background: var(--panel);
      border-radius: 10px;
      padding: 14px;
      margin-top: 12px;
      font-size: 14px;
    }
    
    .devBox > div {
      margin: 8px 0;
    }
    
    @media (max-width: 600px) {
      .app { 
        max-width: 100vw; 
      }
      .chatBox { 
        left: 10px; 
        right: 10px;
        width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="header-content">
        <a href="index.html" class="logo">âˆž INFINITY</a>
        <div class="nav">
          <a href="dashboard.html" class="active">Dashboard</a>
          <button onclick="logout()" class="btn-secondary" style="padding:6px 12px;font-size:14px;">Logout</button>
        </div>
      </div>
    </div>
    
    <main class="container" id="mainPanel">
      <div class="welcome-banner">
        <h3>Welcome back, <span id="userName">User</span>!</h3>
        <p>Your secure session is active</p>
      </div>
      
      <div class="card">
        <h2>Infinity Portal</h2>
        <p class="text-muted" style="margin-bottom:16px;">All your tools, AI, and projects â€” one unified platform.</p>
        
        <div class="apps">
          <div class="app-link">
            <a href="pages/chat.html">Rogers AI Chat</a>
            <div class="desc">Conversational AI powered by Mongoose OS</div>
            <span class="live">âœ“ ONLINE</span>
          </div>
          
          <div class="app-link">
            <a href="pages/pi-singer.html">Pi Singer</a>
            <div class="desc">Digit-to-music generator with live waveform</div>
            <span class="live">âœ“ ONLINE</span>
          </div>
          
          <div class="app-link">
            <a href="pages/oscilloscope.html">Oscilloscope</a>
            <div class="desc">Signal generator with frequency visualization</div>
            <span class="live">âœ“ ONLINE</span>
          </div>
          
          <div class="app-link">
            <a href="pages/3d-viewer.html">3D Viewer</a>
            <div class="desc">Simple 3D panel with CSS animations</div>
            <span class="live">âœ“ ONLINE</span>
          </div>
          
          <div class="app-link">
            <a href="portal.html">Classic Portal</a>
            <div class="desc">Legacy unified portal (standalone)</div>
            <span class="live">âœ“ ONLINE</span>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h2>Session Information</h2>
        <div class="devBox">
          <div><b>User ID:</b> <span id="userId">â€”</span></div>
          <div><b>Email:</b> <span id="userEmail">â€”</span></div>
          <div><b>Login Time:</b> <span id="loginTime">â€”</span></div>
          <div><b>Session Expires:</b> <span id="expiresAt">â€”</span></div>
          <div><b>Mongoose OS:</b> <span id="mongooseStatus">Checking...</span></div>
        </div>
      </div>
    </main>

    <!-- Rogers AI Floating Chat -->
    <div class="rogersDock">
      <button class="rogBtn" id="rogBtn" title="Rogers AI">ðŸ¤–</button>
    </div>
    
    <div class="chatBox" id="chatBox">
      <div class="chatHeader">
        <span>Rogers AI</span>
        <button onclick="toggleChat()" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;">âœ•</button>
      </div>
      <div class="chatBody" id="chatBody"></div>
      <form class="chatInput" onsubmit="event.preventDefault();sendChat();">
        <input id="chatIn" autocomplete="off" placeholder="Ask Rogers anything...">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <script src="assets/js/infinity-auth.js"></script>
  <script src="mongoose/lib/mongoose-client.js"></script>
  <script>
    // Check authentication on page load
    window.addEventListener('DOMContentLoaded', async () => {
      if (!InfinityAuth.isAuthenticated()) {
        window.location.href = 'index.html';
        return;
      }
      
      await initializeDashboard();
    });

    async function initializeDashboard() {
      const userInfo = InfinityAuth.getUserInfo();
      const session = InfinityAuth.getSession();
      
      if (userInfo) {
        document.getElementById('userName').textContent = userInfo.username;
        document.getElementById('userId').textContent = userInfo.userId;
        document.getElementById('userEmail').textContent = userInfo.email;
      }
      
      if (session) {
        const loginTime = new Date(session.loginTime);
        const expiresAt = new Date(session.expiresAt);
        
        document.getElementById('loginTime').textContent = loginTime.toLocaleString();
        document.getElementById('expiresAt').textContent = expiresAt.toLocaleString();
      }

      // Check Mongoose status
      const health = await window.MongooseClient.healthCheck();
      const statusSpan = document.getElementById('mongooseStatus');
      if (health.healthy) {
        statusSpan.textContent = `${health.mode} mode âœ“`;
        statusSpan.style.color = '#22c55e';
      } else {
        statusSpan.textContent = 'Offline';
        statusSpan.style.color = '#f59e0b';
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        InfinityAuth.logout();
      }
    }

    /* Rogers Chat Dock Logic */
    const rogBtn = document.getElementById('rogBtn');
    const chatBox = document.getElementById('chatBox');
    const chatBody = document.getElementById('chatBody');
    const chatIn = document.getElementById('chatIn');

    rogBtn.onclick = () => { 
      chatBox.classList.add('open'); 
      setTimeout(() => chatIn.focus(), 120); 
    }

    function toggleChat() { 
      chatBox.classList.remove('open'); 
    }

    function addBubble(role, text) {
      const div = document.createElement('div');
      div.className = 'bubble ' + (role === 'me' ? 'me' : 'ai');
      div.textContent = text;
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function sendChat() {
      const t = chatIn.value.trim();
      if (!t) return;
      
      addBubble('me', t);
      chatIn.value = '';
      
      // Show typing indicator
      const typingDiv = document.createElement('div');
      typingDiv.className = 'bubble ai';
      typingDiv.textContent = 'Thinking...';
      chatBody.appendChild(typingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      try {
        // Query Mongoose OS
        const response = await window.MongooseClient.chat('Joe', t, {
          page: 'dashboard',
          user: InfinityAuth.getUserInfo()
        });
        
        typingDiv.remove();
        
        if (response.ok) {
          addBubble('ai', response.answer);
        } else {
          const fallback = window.MongooseClient.getOfflineFallback(t);
          addBubble('ai', fallback);
        }
      } catch (error) {
        typingDiv.remove();
        addBubble('ai', 'Error connecting to Mongoose OS. Please try again.');
      }
    }

    // Initial greeting
    addBubble('ai', "Hi! Rogers AI is ready. Ask anything or say 'help'.");
  </script>
</body>
</html>
