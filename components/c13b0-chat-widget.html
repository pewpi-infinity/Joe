<!-- C13B0 Chat Widget - Mongoose OS Integration -->
<style>
  .c13b0-chatfab{
    position:fixed;
    right:18px;
    bottom:18px;
    z-index:99999;
    border-radius:999px;
    padding:14px 18px;
    font-weight:700;
    box-shadow:0 10px 30px rgba(0,0,0,.25);
    cursor:pointer;
    user-select:none;
    background: linear-gradient(135deg, #003087, #0b5fd7);
    color: white;
    border: none;
    font-size: 16px;
    transition: all 0.2s;
  }
  
  .c13b0-chatfab:hover{
    transform: translateY(-2px);
    box-shadow:0 12px 35px rgba(0,0,0,.35);
  }
  
  .c13b0-chatpanel{
    position:fixed;
    right:18px;
    bottom:72px;
    width:min(520px,calc(100vw - 36px));
    height:min(560px,calc(100vh - 120px));
    z-index:99999;
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 14px 40px rgba(0,0,0,.35);
    display:none;
    background: rgba(0,0,0,.92);
    color: white;
  }
  
  .c13b0-chathead{
    padding:12px 14px;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid rgba(255,255,255,.10);
    background: linear-gradient(135deg, #003087, #0b5fd7);
  }
  
  .c13b0-chatbody{
    height:calc(100% - 110px);
    overflow:auto;
    padding:12px 14px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
    font-size:13px;
  }
  
  .c13b0-chatline{
    white-space:pre-wrap;
    margin:8px 0;
    padding: 8px 12px;
    background: rgba(255,255,255,.05);
    border-radius: 8px;
    border-left: 3px solid rgba(11, 95, 215, 0.5);
  }
  
  .c13b0-chatline.user{
    background: rgba(11, 95, 215, 0.2);
    border-left-color: #0b5fd7;
  }
  
  .c13b0-chatline.system{
    background: rgba(34, 197, 94, 0.15);
    border-left-color: #22c55e;
  }
  
  .c13b0-chatbar{
    display:flex;
    gap:8px;
    padding:10px 12px;
    border-top:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.5);
  }
  
  .c13b0-chatin{
    flex:1;
    border-radius:12px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.12);
    outline:none;
    background:rgba(255,255,255,.06);
    color:white;
  }
  
  .c13b0-chatbtn{
    border-radius:12px;
    padding:10px 16px;
    font-weight:800;
    border:0;
    cursor:pointer;
    background: linear-gradient(135deg, #003087, #0b5fd7);
    color: white;
    transition: all 0.2s;
  }
  
  .c13b0-chatbtn:hover{
    opacity: 0.9;
  }
</style>

<div id="c13b0_chat_fab" class="c13b0-chatfab">ðŸ§±ðŸ’¬ CHAT</div>

<div id="c13b0_chat_panel" class="c13b0-chatpanel" role="dialog" aria-label="C13B0 Chat">
  <div class="c13b0-chathead">
    <div>ðŸ§±ðŸ’¬ Mongoose OS Chat</div>
    <div style="display:flex;gap:8px;align-items:center">
      <small id="c13b0_chat_repo" style="opacity:.8">repo: Joe</small>
      <button id="c13b0_chat_close" class="c13b0-chatbtn" style="padding:6px 12px">âœ•</button>
    </div>
  </div>
  <div id="c13b0_chat_body" class="c13b0-chatbody"></div>
  <div class="c13b0-chatbar">
    <input id="c13b0_chat_in" class="c13b0-chatin" placeholder="Ask this repo... (powered by Mongoose OS)" />
    <button id="c13b0_chat_send" class="c13b0-chatbtn">SEND</button>
  </div>
</div>

<script>
(function(){
  const fab = document.getElementById("c13b0_chat_fab");
  const panel = document.getElementById("c13b0_chat_panel");
  const body = document.getElementById("c13b0_chat_body");
  const input = document.getElementById("c13b0_chat_in");
  const send = document.getElementById("c13b0_chat_send");
  const close = document.getElementById("c13b0_chat_close");
  const repoLabel = document.getElementById("c13b0_chat_repo");

  const repo = "Joe"; // Could be dynamic based on location
  repoLabel.textContent = "repo: " + repo;

  function line(txt, type = 'bot'){
    const div=document.createElement("div");
    div.className="c13b0-chatline " + (type === 'user' ? 'user' : type === 'system' ? 'system' : '');
    div.textContent=txt;
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
  }

  function open(){ 
    panel.style.display="block"; 
    input.focus(); 
  }
  
  function shut(){ 
    panel.style.display="none"; 
  }

  fab.addEventListener("click", open);
  close.addEventListener("click", shut);
  
  window.addEventListener("click",(e)=>{
    if(panel.style.display==="block"){
      if(!panel.contains(e.target) && e.target!==fab) shut();
    }
  });

  async function ask(){
    const q=(input.value||"").trim();
    if(!q) return;

    line("> " + q, 'user');
    input.value="";
    
    line("â³ Querying Mongoose OS...", 'system');

    try{
      // Auto-detect router endpoint
      const port = window.location.port === '8080' ? '5001' : (window.location.port || '5001');
      const routerUrl = `http://127.0.0.1:${port}/router/ask`;
      
      // Use /router/ask endpoint
      const res = await fetch(routerUrl, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ repo, query:q, t: Date.now() })
      });
      
      if (!res.ok) {
        throw new Error('Router returned error: ' + res.status);
      }
      
      const data = await res.json();
      
      // Remove "querying" message
      const messages = body.querySelectorAll('.c13b0-chatline');
      if (messages.length > 0) {
        const lastMsg = messages[messages.length - 1];
        if (lastMsg.textContent.includes('Querying')) {
          lastMsg.remove();
        }
      }
      
      if(!data || !data.ok){
        line("âš ï¸ Router error: " + (data && data.error ? data.error : "unknown"));
        return;
      }
      
      if(data.answer) {
        line(data.answer);
      }
      
      if(data.token){
        line("ðŸ§±ðŸŸ¡ TOKEN â†’ " + JSON.stringify(data.token), 'system');
      } else {
        line("ðŸ§±ðŸ“ no token returned", 'system');
      }
      
      if(data.mongoose){
        line("ðŸ Mongoose: " + data.mongoose.mode + " mode by " + data.mongoose.operator, 'system');
      }
      
    }catch(err){
      // Remove "querying" message
      const messages = body.querySelectorAll('.c13b0-chatline');
      if (messages.length > 0) {
        const lastMsg = messages[messages.length - 1];
        if (lastMsg.textContent.includes('Querying')) {
          lastMsg.remove();
        }
      }
      
      line("âš ï¸ Connection error: " + err.message);
      line("ðŸ’¡ Make sure router.py is running: python3 router.py", 'system');
    }
  }

  send.addEventListener("click", ask);
  input.addEventListener("keydown",(e)=>{ if(e.key==="Enter") ask(); });
  
  // Initial message
  line("ðŸ§±ðŸ’¬ C13B0 Chat Widget ready. Powered by Mongoose OS.", 'system');
})();
</script>
